
<!DOCTYPE HTML>
<html>
<head>
<meta charset="UTF-8" />

<title>Babeltower在线聊天系统</title>

<link rel="stylesheet" type="text/css" href="static/jqueryui/jquery-ui.css">

<script type="text/javascript" src="static/scripts/jquery.js"></script>
<script type="text/javascript" src="static/scripts/jquery-ui.js"></script>
<script type="text/javascript" src="static/scripts/hash/sha.js"></script>
<script type="text/javascript" src="static/scripts/dialog.js"></script>

<script type="text/javascript">
var token = '';
var tokenValid = false;
var pullFailCount = 0;
var pullFailCount_Max = 3;

function doPull(){
    $.post('pull.php', { 'token':token },
            function(j){
                if(j.type != 'success'){
                    if(j.error != null){
                        switch(j.error.code){
                            case(-1):
                                tokenValid = false;
                                loginSetInfo('会话过期，或被服务器中止。','error');
                                break;
                            default:
                                break;
                        }
                    }
                } else {
                }
                pullFailCount = 0;
            },
            'json');
}

function loginDo(username,password){
    var nowtime = Math.round(new Date().getTime()/1000);

    var passwordSHA1 = (new jsSHA(password, "TEXT")).getHash("SHA-1","HEX");

    var shaObj = new jsSHA(passwordSHA1, "TEXT");
    var hmac = shaObj.getHMAC(username + nowtime, "TEXT", "SHA-1", "HEX");
    
    $('#loginForm input[name=password]').val('');

    $.post('authenticate.php',{ 'username':username, 'password':hmac, 'nowtime':nowtime },
            function(j){
                if(j.type == null)
                    return;
                if(j.type != 'success'){
                    var desc = '';
                    if(j.description != null)
                        desc = j.description;
                    else if(j.error != null)
                        desc = j.error.message;
                    else
                        desc = '未知错误';
                    loginSetInfo(desc,'error');
                } else {
                    $('#loginForm').dialog('close');
                    tokenValid = true;
                    token = j.data.token;
                }
            },
           'json');
}
function loginShow(){
    pullFailCount = 0;
    tokenValid = false;
    token = '';
    $('#loginForm').dialog('open');
}
function loginSetInfo(info,type){
    $('#loginForm div[name=message]')
        .html(info)
        .removeAttr('style')
        .addClass('ui-state-' + type);
}

function engine(){
    if(tokenValid == false || pullFailCount >= pullFailCount_Max){
        loginShow();
        setTimeout(engine,1000);
        return;
    }
    setTimeout(engine,5000);
    pullFailCount += 1;
    doPull();
}

$(function(){
    $('#loginForm,#changePwdForm').dialog({        
        autoOpen: false,
        modal: true,
        resizable: false,
    });
    $('#loginForm').dialog('option', 'buttons', [{
        click: function(){ loginDo($('#loginForm input[name=username]').val(), $('#loginForm input[name=password]').val()); },
        text: '登录',
    }]);
    $('#changePwdForm').dialog('option', 'buttons', [{
        click: function(){ alert('尚未制作，请联系作者。'); },
        text: '修改密码',
    }]);
    $('#talkTest').click( function(){ showDialog('test'); } );

    engine();
});
</script>
</head>
<body>
<div id="loginForm" title="登录">
<div name="message"></div>
用户名<input name="username" type="text" required/><br />
密码<input name="password" type="password" required/>
</div>
<div id="changePwdForm" title="修改密码">
新密码<input name="newpwd" type="password" required/><br />
确认新密码<input name="newpwd2" type="password" required/>
</div>

<button id="talkTest">和test聊天</button>

</body>
</html>
