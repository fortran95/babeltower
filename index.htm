
<!DOCTYPE HTML>
<html>
<head>
<meta charset="UTF-8" />

<title>Babeltower在线聊天系统</title>

<link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.10.0/themes/base/jquery-ui.css">

<script type="text/javascript" src="http://code.jquery.com/jquery-1.9.0.js"></script>
<script type="text/javascript" src="http://code.jquery.com/ui/1.10.0/jquery-ui.js"></script>
<script type="text/javascript" src="scripts/hash/sha.js"></script>

<style>
body{
font: 90% "Trebuchet MS", sans-serif;
margin: 50px;
}
.demoHeaders {
margin-top: 2em;
}
#dialog-link {
padding: .4em 1em .4em 20px;
text-decoration: none;
position: relative;
}
#dialog-link span.ui-icon {
margin: 0 5px 0 0;
position: absolute;
left: .2em;
top: 50%;
margin-top: -8px;
}
#icons {
margin: 0;
padding: 0;
}
#icons li {
margin: 2px;
position: relative;
padding: 4px 0;
cursor: pointer;
float: left;
list-style: none;
}
#icons span.ui-icon {
float: left;
margin: 0 4px;
}
.fakewindowcontain .ui-widget-overlay {
position: absolute;
}
</style>

<script type="text/javascript">
var token = '';
var tokenValid = false;

function doPull(){
    $.post('pull.php', { 'token':token },
            function(j){
                if(j.type == null)
                    return;
                if(j.type != 'success'){
                    
                } else {
                }
            },
            'json');
}

function loginDo(username,password){
    var nowtime = Math.round(new Date().getTime()/1000);

    var shaObj = new jsSHA(password, "TEXT");
    var hmac = shaObj.getHMAC(username + nowtime, "TEXT", "SHA-1", "HEX");
    
    $.post('authenticate.php',{ 'username':username, 'password':hmac, 'nowtime':nowtime },
            function(j){
                if(j.type == null)
                    return;
                if(j.type != 'success'){
                    var desc = '';
                    if(j.description != null)
                        desc = j.description;
                    else if(j.error != null)
                        desc = j.error.message;
                    else
                        desc = '未知错误';
                    $('#loginForm div[name=message]')
                    .html(desc)
                    .removeAttr('style')
                    .addClass('ui-state-error');
                } else {
                    $('#loginForm').dialog('close');
                    $('#loginForm input[name=password]').val('');
                    tokenValid = true;
                    token = j.data.token;
                }
            },
           'json');
}
function loginShow(){
    $('#loginForm').dialog('open');
}

function engine(){
    if(tokenValid == false){
        loginShow();
        setTimeout(engine,1000);
        return;
    }
    setTimeout(engine,10000);
    doPull();
}

$(function(){
    $('#loginForm').dialog({
        buttons: [{
            click: function(){ loginDo($('#loginForm input[name=username]').val(), $('#loginForm input[name=password]').val()); },
            text: '登录',
        }],
        autoOpen: false,
        modal: true,
        resizable: false,
    });
    engine();
});
</script>
</head>
<body>
<div id="loginForm" title="登录">
<div name="message"></div>
用户名<input name="username" type="text" required/><br />
密码<input name="password" type="password" required/>
</div>
</body>
</html>
